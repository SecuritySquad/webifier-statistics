---
title: "webifier Statistics"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    logo: webifier-small.png
    favicon: webifier-small.png
    css: style.css
    vertical_layout: fill 
    navbar:
      - { title: "Startseite", href: "https://webifier.de/", align: right }
params:
  dbname: webifier_v1-SNAPSHOT

---

```{r setup, include=FALSE}
usePackage <- function(p)
{
  if (!is.element(p, installed.packages()[,1]))
    install.packages(p, repos='http://cran.r-project.org', dep = TRUE)
}
usePackage('flexdashboard')
usePackage('RMongo')
usePackage('RJSONIO')
usePackage('plotly')
usePackage('ggplot2')
usePackage('urltools')
library('flexdashboard')
library('urltools')
library('RMongo')
library('RJSONIO')
library('plotly')
library('ggplot2')
mg1 <- mongoDbConnect(params$dbname)
print(dbShowCollections(mg1))
resultType <- dbGetQueryForKeys(mg1, 'webifierTestResultData',"{}", "{overallResultType:1}",skip=0,limit=Inf)
```

Dashboard
=====================================

Row {data-height=100}
-----------------------------------------------------------------------

### analysierte Webseiten

```{r}
valueBox(nrow(resultType), icon="fa-bar-chart")
```

### saubere Webseiten

```{r}
value <- nrow(resultType[resultType$overallResultType=='CLEAN',])
base <- nrow(resultType)
gauge(value, min = 0, max = base, label = paste(round((value/base)*100),"%",sep=""), gaugeSectors(
  success = c(0, base), warning = c(-10, -5), danger = c(-4, -1)
))
```

### verdÃ¤chtige Webseiten

```{r}
value <- nrow(resultType[resultType$overallResultType=='SUSPICIOUS',])
base <- nrow(resultType)
gauge(value, min = 0, max = base, label = paste(round((value/base)*100),"%",sep=""), gaugeSectors(
  success = c(-10, -5), warning = c(0, base), danger = c(-4, -1)
))
```

### bedrohliche Webseiten

```{r}
value <- nrow(resultType[resultType$overallResultType=='MALICIOUS',])
base <- nrow(resultType)
gauge(value, min = 0, max = base, label = paste(round((value/base)*100),"%",sep=""), gaugeSectors(
  success = c(-4, -1), warning = c(-10, -5), danger = c(0, base)
))
```

Row
-----------------------------------------------------------------------

Gesamttestauswertungen
=====================================

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Testergebnisverteilung

```{r}
testResults <- dbGetQueryForKeys(mg1, 'webifierSingleTestResultData',"{}", '{_id:0,name:1,result:1}',skip=0,limit=Inf)

testResults <- testResults[,-1]
p <- ggplot(data = testResults, aes(x = name, fill = result)) +
            geom_bar(position = "dodge") +
  scale_fill_manual(values=c("darkgreen","red","orange","grey"))
ggplotly(p)

```

### Erkennungen auf Top-Level-Domains

```{r}
result <- dbGetQueryForKeys(mg1, 'webifierTestResultData',"{}", "{host:1,overallResultType:1}",skip=0,limit=Inf)
result[,1] <- tld_extract(result[,1],NULL)[,2]
names(result)[1] <- "TLD"
result <- result[result[,2]!="CLEAN",]
p <- ggplot(data = result, aes(x = TLD, fill = overallResultType)) +
            geom_bar(position = "dodge") +
  scale_fill_manual(values=c("red","orange","grey"))
ggplotly(p)



```

### Verteilung der getesteten Top-Level-Domains

```{r}
result <- dbGetQueryForKeys(mg1, 'webifierTestResultData',"{}", "{host:1,overallResultType:1}",skip=0,limit=Inf)
result[,1] <- tld_extract(result[,1],NULL)[,2]
names(result)[1] <- "TLD"
tlds <- result[,-3]
names(tlds)[2] <- "count"
tlds <- aggregate(count ~ TLD,tlds,length)
tlds <- tlds[tlds[,2]>3,]
p <- plot_ly(tlds, labels = ~TLD, values = ~count, type = 'pie') %>%
  layout(title = 'Verteilung der getesteten Top-Level-Domains',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

ggplotly(p)
```

Einzeltestauswertungen
=====================================


Row {.tabset .tabset-fade}
-----------------------------------------------------------------------

### Virusscan

```{r}

```

### Portscan

```{r}

```

### IPScan

```{r}

```

### Phishingdetector

```{r}

```

### weitere Testanalysen

```{r}

```